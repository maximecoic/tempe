<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Climat Kindle</title>
    <style>
        /* RESET & BASE */
        * { box-sizing: border-box; }
        body {
            margin: 0;
            padding: 8px;
            font-family: "Bookerly", serif; /* Police native Kindle */
            background-color: white;
            color: black;
            font-size: 16px;
        }

        /* UTILITAIRES FLEXBOX (Plus compatible que Grid) */
        .row {
            display: -webkit-box;      /* OLD - iOS 6-, Safari 3.1-6 */
            display: -moz-box;         /* OLD - Firefox 19- (buggy but mostly works) */
            display: -ms-flexbox;      /* TWEENER - IE 10 */
            display: -webkit-flex;     /* NEW - Chrome */
            display: flex;             /* NEW, Spec - Opera 12.1, Firefox 20+ */
            justify-content: space-between;
            width: 100%;
        }
        
        .col-half { width: 48%; }

        /* COMPOSANTS */
        header {
            border-bottom: 3px solid black;
            padding-bottom: 5px;
            margin-bottom: 15px;
        }
        h1 { margin: 0; font-size: 20px; text-transform: uppercase; }
        .date-display { font-size: 14px; font-family: monospace; text-align: right; }

        /* CARTES KPI */
        .card {
            border: 2px solid black;
            padding: 10px;
            text-align: center;
            margin-bottom: 15px;
        }
        .card-title {
            display: block;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
            border-bottom: 1px solid black;
            padding-bottom: 4px;
            margin-bottom: 4px;
        }
        .card-value {
            font-size: 36px;
            font-weight: bold;
            display: block;
        }

        /* GRAPHIQUE SVG */
        .chart-box {
            border: 2px solid black;
            height: 200px;
            margin-bottom: 15px;
            padding: 5px;
            position: relative;
        }
        svg { width: 100%; height: 100%; overflow: hidden; }
        
        /* Styles SVG */
        .line-out { fill: none; stroke: black; stroke-width: 1; stroke-dasharray: 4,4; }
        .line-in { fill: none; stroke: black; stroke-width: 4; }
        .grid-line { stroke: #999; stroke-width: 1; }
        .chart-txt { font-size: 10px; font-family: monospace; }

        /* LISTE PIECES */
        .room-row {
            border-bottom: 1px dotted black;
            padding: 6px 0;
            font-size: 16px;
        }
        .room-val { font-weight: bold; font-family: sans-serif; }

        /* BOUTON */
        #btn-refresh {
            display: block;
            width: 100%;
            background: black;
            color: white;
            border: none;
            padding: 15px;
            font-size: 18px;
            font-weight: bold;
            text-transform: uppercase;
            margin-top: 20px;
            cursor: pointer;
        }

        /* DEBUG CONSOLE (Essentiel pour Kindle) */
        #console-log {
            margin-top: 30px;
            border-top: 1px solid #ccc;
            font-family: monospace;
            font-size: 10px;
            color: #555;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>

    <header class="row">
        <h1>Mon Climat</h1>
        <div id="last-update" class="date-display">Chargement...</div>
    </header>

    <!-- KPIs -->
    <div class="row">
        <div class="col-half card">
            <span class="card-title">Extérieur</span>
            <span id="val-paris" class="card-value">--</span>
        </div>
        <div class="col-half card">
            <span class="card-title">Intérieur</span>
            <span id="val-indoor" class="card-value">--</span>
        </div>
    </div>

    <!-- Graphique -->
    <div class="chart-box">
        <svg id="svg-graph" viewBox="0 0 100 100" preserveAspectRatio="none">
            <!-- Le contenu sera injecté par JS -->
        </svg>
    </div>
    <!-- Légende simple -->
    <div style="text-align:center; font-size: 10px; margin-top:-10px; margin-bottom: 15px;">
        <span style="font-weight:bold">Trait épais:</span> Intérieur &nbsp;|&nbsp; 
        <span style="font-style:italic">Pointillés:</span> Extérieur
    </div>

    <!-- Liste -->
    <div id="list-container"></div>

    <button id="btn-refresh" onclick="appInit()">Rafraîchir</button>

    <!-- Zone de debug pour comprendre les erreurs Kindle -->
    <div id="console-log">Logs système:</div>

    <script>
        /**
         * LOGGGER COMPATIBLE KINDLE
         * Affiche les erreurs directement sur l'écran car pas de console développeur.
         */
        function log(msg) {
            var el = document.getElementById('console-log');
            if (el) {
                var time = new Date().toLocaleTimeString();
                el.innerHTML += "\n[" + time + "] " + msg;
            }
        }

        // Catch global errors
        window.onerror = function(message, source, lineno, colno, error) {
            log("ERREUR CRITIQUE: " + message + " ligne " + lineno);
        };

        // VARIABLES GLOBALES (Pas de const/let)
        var DATA_URL = "https://raw.githubusercontent.com/maximecoic/tempe/refs/heads/main/data.json";
        
        var CONFIG = {
            'Paris': { label: 'Extérieur', indoor: false },
            'Salon': { label: 'Salon', indoor: true },
            'Bureau': { label: 'Bureau', indoor: true },
            'Chambre': { label: 'Chambre', indoor: true },
            'Chambre de Lilou': { label: 'Ch. Lilou', indoor: true },
            'SdB': { label: 'Bain', indoor: true },
            'Cuisine': { label: 'Cuisine', indoor: true }
        };

        function appInit() {
            log("Démarrage de la récupération...");
            document.getElementById('last-update').innerHTML = "Chargement...";
            
            var xhr = new XMLHttpRequest();
            // Le paramètre timestamp évite le cache agressif du Kindle
            var cleanUrl = DATA_URL + "?t=" + new Date().getTime();
            
            xhr.open('GET', cleanUrl, true);
            
            xhr.onload = function() {
                if (xhr.status >= 200 && xhr.status < 400) {
                    log("Données reçues (Taille: " + xhr.responseText.length + ")");
                    try {
                        var data = JSON.parse(xhr.responseText);
                        renderApp(data);
                    } catch (e) {
                        log("Erreur Parsing JSON: " + e.message);
                    }
                } else {
                    log("Erreur Serveur: " + xhr.status);
                }
            };

            xhr.onerror = function() {
                log("Erreur Réseau (CORS/SSL). Vérifiez le Wifi.");
            };

            xhr.send();
        }

        function getMoyenneInterieure(entry) {
            var total = 0;
            var count = 0;
            for (var key in CONFIG) {
                if (CONFIG[key].indoor && entry[key] !== "" && entry[key] !== null && entry[key] !== undefined) {
                    var val = parseFloat(entry[key]);
                    if (!isNaN(val)) {
                        total += val;
                        count++;
                    }
                }
            }
            return count > 0 ? (total / count) : null;
        }

        function renderApp(data) {
            if (!data || data.length === 0) {
                log("Données vides");
                return;
            }

            // Prendre le dernier point
            var last = data[data.length - 1];
            log("Dernier point: " + last.Heure);

            // Mise à jour date
            // Parsing manuel de la date pour éviter les bugs de locale sur vieux navigateurs
            // Format supposé: "2023-10-27T10:00:00..."
            var timePart = "--:--";
            try {
                if(last.Heure.indexOf('T') > -1) {
                    timePart = last.Heure.split('T')[1].substring(0, 5);
                }
            } catch(e) {}
            document.getElementById('last-update').innerHTML = timePart;

            // KPIs
            var tempParis = parseFloat(last.Paris).toFixed(1);
            var tempIn = getMoyenneInterieure(last);
            
            document.getElementById('val-paris').innerHTML = tempParis + "°";
            document.getElementById('val-indoor').innerHTML = tempIn !== null ? tempIn.toFixed(1) + "°" : "--";

            // Liste
            var listHtml = "";
            for (var k in CONFIG) {
                if (k === 'Paris') continue; // On ne met pas Paris dans la liste
                var val = last[k];
                if (val !== "" && val !== null && val !== undefined) {
                    var numVal = parseFloat(val).toFixed(1);
                    listHtml += '<div class="row room-row">';
                    listHtml += '<span>' + CONFIG[k].label + '</span>';
                    listHtml += '<span class="room-val">' + numVal + '°</span>';
                    listHtml += '</div>';
                }
            }
            document.getElementById('list-container').innerHTML = listHtml;

            // Graphique (40 derniers points)
            renderChart(data.slice(-40));
            log("Affichage terminé.");
        }

        function renderChart(subset) {
            var svg = document.getElementById('svg-graph');
            var svgContent = "";

            // Préparer les tableaux
            var arrOut = [];
            var arrIn = [];
            var min = 100; 
            var max = -100;

            for (var i = 0; i < subset.length; i++) {
                var p = parseFloat(subset[i].Paris);
                var inn = getMoyenneInterieure(subset[i]);

                arrOut.push(p);
                arrIn.push(inn);

                if (!isNaN(p)) {
                    if (p < min) min = p;
                    if (p > max) max = p;
                }
                if (inn !== null) {
                    if (inn < min) min = inn;
                    if (inn > max) max = inn;
                }
            }

            // Marges
            min = Math.floor(min - 1);
            max = Math.ceil(max + 1);
            var range = max - min;
            if (range === 0) range = 10; // Sécurité

            // Fonction helper pour coord Y
            function getY(val) {
                return 100 - ((val - min) / range * 100);
            }

            // Grille horizontale (3 lignes)
            for (var j = 1; j < 4; j++) {
                var lineY = j * 25;
                svgContent += '<line x1="0" y1="' + lineY + '" x2="100" y2="' + lineY + '" class="grid-line" />';
            }

            // Tracer Ligne Extérieure
            var pathOut = "M";
            var hasStarted = false;
            for (var i = 0; i < arrOut.length; i++) {
                if (isNaN(arrOut[i])) continue;
                var x = (i / (arrOut.length - 1)) * 100;
                var y = getY(arrOut[i]);
                pathOut += (hasStarted ? " L " : " ") + x.toFixed(1) + "," + y.toFixed(1);
                hasStarted = true;
            }
            svgContent += '<path d="' + pathOut + '" class="line-out" />';

            // Tracer Ligne Intérieure
            var pathIn = "M";
            hasStarted = false;
            for (var i = 0; i < arrIn.length; i++) {
                if (arrIn[i] === null) continue;
                var x = (i / (arrIn.length - 1)) * 100;
                var y = getY(arrIn[i]);
                pathIn += (hasStarted ? " L " : " ") + x.toFixed(1) + "," + y.toFixed(1);
                hasStarted = true;
            }
            svgContent += '<path d="' + pathIn + '" class="line-in" />';

            // Labels Max/Min
            svgContent += '<text x="2" y="10" class="chart-txt">' + max + '°</text>';
            svgContent += '<text x="2" y="98" class="chart-txt">' + min + '°</text>';

            svg.innerHTML = svgContent;
        }

        // Lancement auto
        appInit();

    </script>
</body>
</html>
