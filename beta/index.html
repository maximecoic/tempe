<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Beta Dashboard - Mon Climat</title>
    <!-- Moteur de rendu Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Bibliothèques React -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel pour transformer le code React dans le navigateur -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Recharts pour les graphiques -->
    <script src="https://unpkg.com/recharts/umd/Recharts.js"></script>
    <!-- Lucide pour les icônes -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">
    <div id="root"></div>

    <!-- Script de type text/babel pour que le navigateur sache qu'il doit le transformer -->
    <script type="text/babel">
        const { useState, useMemo, useEffect } = React;
        const { 
            LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, 
            ResponsiveContainer, Brush 
        } = Recharts;
        
        const DATA_URL = "https://raw.githubusercontent.com/maximecoic/tempe/refs/heads/main/data.json";

        const ROOM_CONFIG = {
            Paris: { color: '#f59e0b', label: 'Extérieur', icon: 'MapPin' },
            Bureau: { color: '#3b82f6', label: 'Bureau', icon: 'Laptop' },
            Chambre: { color: '#8b5cf6', label: 'Chambre', icon: 'Bed' },
            SdB: { color: '#06b6d4', label: 'SdB', icon: 'Bath' },
            Cuisine: { color: '#ef4444', label: 'Cuisine', icon: 'ChefHat' },
            "Chambre de Lilou": { color: '#ec4899', label: 'Ch. Lilou', icon: 'Baby' },
            Salon: { color: '#10b981', label: 'Salon', icon: 'Sofa' },
        };

        const TIME_RANGES = [
            { label: '2h', ms: 2 * 60 * 60 * 1000 },
            { label: '6h', ms: 6 * 60 * 60 * 1000 },
            { label: '24h', ms: 24 * 60 * 60 * 1000 },
            { label: '2j', ms: 2 * 24 * 60 * 60 * 1000 },
            { label: '1 sem', ms: 7 * 24 * 60 * 60 * 1000 },
            { label: 'Tout', ms: 0 },
        ];

        const DynamicIcon = ({ name, size = 20, className = "" }) => {
            const IconComponent = lucide[name] || lucide.Home;
            return <IconComponent size={size} className={className} />;
        };

        const CustomTooltip = ({ active, payload, label }) => {
            if (active && payload && payload.length) {
                const sorted = [...payload].sort((a, b) => b.value - a.value);
                return (
                    <div className="bg-white p-3 rounded-xl shadow-xl border border-slate-100 min-w-[150px]">
                        <p className="text-[10px] font-bold text-slate-400 uppercase mb-2 border-b pb-1">{label}</p>
                        <div className="space-y-1.5">
                            {sorted.map((entry, index) => (
                                <div key={index} className="flex items-center justify-between gap-4">
                                    <div className="flex items-center gap-2">
                                        <div className="w-2 h-2 rounded-full" style={{ backgroundColor: entry.color }} />
                                        <span className="text-xs text-slate-600 font-medium">{entry.name}</span>
                                    </div>
                                    <span className="text-xs font-bold text-slate-800">{entry.value.toFixed(1)}°</span>
                                </div>
                            ))}
                        </div>
                    </div>
                );
            }
            return null;
        };

        const App = () => {
            const [logs, setLogs] = useState([]);
            const [loading, setLoading] = useState(true);
            const [selectedRange, setSelectedRange] = useState(TIME_RANGES[2]);
            const [hiddenKeys, setHiddenKeys] = useState([]);

            useEffect(() => {
                fetch(DATA_URL)
                    .then(res => res.json())
                    .then(data => {
                        setLogs(Array.isArray(data) ? data : []);
                        setLoading(false);
                    })
                    .catch(() => setLoading(false));
            }, []);

            const processedData = useMemo(() => {
                return logs.map(log => {
                    const date = new Date(log.Heure);
                    const timeStr = date.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
                    const cleanLog = { 
                        ...log, 
                        formattedTime: timeStr, 
                        fullDate: date.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' }) + ' ' + timeStr,
                        timestamp: date.getTime() 
                    };
                    Object.keys(ROOM_CONFIG).forEach(key => {
                        if (cleanLog[key] === "" || cleanLog[key] === undefined) cleanLog[key] = null;
                        else cleanLog[key] = Number(cleanLog[key]);
                    });
                    return cleanLog;
                });
            }, [logs]);

            const latestLog = processedData[processedData.length - 1];
            const previousLog = processedData[processedData.length - 2];

            const chartData = useMemo(() => {
                if (!latestLog) return [];
                if (selectedRange.ms === 0) return processedData;
                return processedData.filter(d => d.timestamp >= (latestLog.timestamp - selectedRange.ms));
            }, [processedData, selectedRange, latestLog]);

            const currentIndoorAvg = useMemo(() => {
                if (!latestLog) return 0;
                const keys = Object.keys(latestLog).filter(k => ROOM_CONFIG[k] && k !== 'Paris' && typeof latestLog[k] === 'number');
                if (!keys.length) return 0;
                return (keys.reduce((acc, k) => acc + latestLog[k], 0) / keys.length).toFixed(1);
            }, [latestLog]);

            if (loading) return <div className="h-screen flex items-center justify-center text-slate-400 font-medium">Initialisation du dashboard beta...</div>;

            return (
                <div className="min-h-screen bg-slate-50 pb-10">
                    <header className="bg-white px-6 py-6 border-b border-slate-100 sticky top-0 z-10">
                        <div className="flex justify-between items-center max-w-md mx-auto">
                            <div>
                                <h1 className="text-xl font-black text-slate-800 tracking-tighter">METEO <span className="text-blue-500">BETA</span></h1>
                                <p className="text-[10px] text-slate-400 flex items-center gap-1 uppercase font-bold tracking-widest"><DynamicIcon name="Clock" size={10} /> {latestLog?.fullDate}</p>
                            </div>
                            <div className="bg-blue-600 text-white px-3 py-1 rounded-full text-[10px] font-black shadow-lg shadow-blue-200">V2.0</div>
                        </div>
                    </header>

                    <main className="p-4 space-y-6 max-w-md mx-auto">
                        <div className="grid grid-cols-2 gap-4">
                            <div className="bg-white p-4 rounded-2xl shadow-sm border border-slate-100">
                                <p className="text-slate-400 text-[10px] font-bold uppercase mb-1">Extérieur</p>
                                <div className="flex justify-between items-end">
                                    <span className="text-3xl font-black text-slate-800">{latestLog?.Paris}°</span>
                                    <div className="p-2 bg-amber-50 rounded-lg"><DynamicIcon name="MapPin" className="text-amber-500" size={20} /></div>
                                </div>
                            </div>
                            <div className="bg-white p-4 rounded-2xl shadow-sm border border-slate-100">
                                <p className="text-slate-400 text-[10px] font-bold uppercase mb-1">Moyenne Int.</p>
                                <div className="flex justify-between items-end">
                                    <span className="text-3xl font-black text-slate-800">{currentIndoorAvg}°</span>
                                    <div className="p-2 bg-indigo-50 rounded-lg"><DynamicIcon name="Home" className="text-indigo-500" size={20} /></div>
                                </div>
                            </div>
                        </div>

                        <div className="bg-white p-4 rounded-2xl shadow-sm border border-slate-100">
                            <div className="flex flex-col gap-4 mb-4">
                                <div className="bg-slate-100 p-1 rounded-xl flex">
                                    {TIME_RANGES.map(r => (
                                        <button key={r.label} onClick={() => setSelectedRange(r)} className={`flex-1 py-1.5 text-xs font-bold rounded-lg transition-all ${selectedRange.label === r.label ? 'bg-white text-slate-800 shadow-sm' : 'text-slate-400'}`}>{r.label}</button>
                                    ))}
                                </div>
                                <div className="flex flex-wrap gap-2">
                                    {Object.entries(ROOM_CONFIG).map(([key, config]) => {
                                        const isHidden = hiddenKeys.includes(key);
                                        if (latestLog?.[key] === null) return null;
                                        return (
                                            <button key={key} onClick={() => setHiddenKeys(prev => isHidden ? prev.filter(k => k !== key) : [...prev, key])} className={`flex items-center gap-1.5 px-3 py-1.5 rounded-full border text-[10px] font-bold transition-all ${isHidden ? 'bg-slate-50 border-slate-100 text-slate-300' : 'bg-white border-slate-200 text-slate-600 shadow-sm'}`}>
                                                <div className="w-2 h-2 rounded-full" style={{backgroundColor: isHidden ? '#cbd5e1' : config.color}} />
                                                {config.label}
                                            </button>
                                        );
                                    })}
                                </div>
                            </div>

                            <div className="h-64 w-full -ml-2">
                                <ResponsiveContainer width="100%" height="100%">
                                    <LineChart data={chartData}>
                                        <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#f1f5f9" />
                                        <XAxis dataKey="formattedTime" hide />
                                        <YAxis domain={['auto', 'auto']} hide />
                                        <Tooltip content={<CustomTooltip />} />
                                        {Object.entries(ROOM_CONFIG).map(([key, config]) => !hiddenKeys.includes(key) && (
                                            <Line key={key} type="monotone" dataKey={key} stroke={config.color} strokeWidth={3} dot={false} connectNulls isAnimationActive={false} />
                                        ))}
                                        <Brush dataKey="formattedTime" height={30} stroke="#e2e8f0" fill="#f8fafc" tickFormatter={() => ''} />
                                    </LineChart>
                                </ResponsiveContainer>
                            </div>
                        </div>

                        <div className="space-y-3">
                            <h3 className="text-sm font-bold text-slate-400 uppercase tracking-widest px-1">Pièces (Tri chaud → froid)</h3>
                            {Object.entries(ROOM_CONFIG)
                                .filter(([key]) => key !== 'Paris' && latestLog?.[key] !== null)
                                .sort((a, b) => (latestLog?.[b[0]] || 0) - (latestLog?.[a[0]] || 0))
                                .map(([key, config]) => {
                                    const val = latestLog?.[key];
                                    const isHidden = hiddenKeys.includes(key);
                                    return (
                                        <button key={key} onClick={() => setHiddenKeys(prev => isHidden ? prev.filter(k => k !== key) : [...prev, key])} className={`w-full flex items-center justify-between bg-white p-4 rounded-2xl border transition-all ${isHidden ? 'opacity-40 border-transparent bg-slate-100' : 'border-slate-100 shadow-sm'}`}>
                                            <div className="flex items-center gap-4">
                                                <div className="p-3 rounded-xl" style={{backgroundColor: config.color + '15', color: config.color}}><DynamicIcon name={config.icon} size={22} /></div>
                                                <span className="font-bold text-slate-700">{config.label}</span>
                                            </div>
                                            <div className="flex items-center gap-3">
                                                <span className="text-xl font-black text-slate-800">{val}°</span>
                                                <DynamicIcon name={isHidden ? 'EyeOff' : 'Eye'} size={16} className="text-slate-300" />
                                            </div>
                                        </button>
                                    );
                                })}
                        </div>
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

